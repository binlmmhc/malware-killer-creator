#**************************************************Common Functons For All**************************************************
$sha256 = New-Object System.Security.Cryptography.SHA256Managed
Function hash_and_compare($file_path, $compare_hash){ 
    Try{ 
        if(Test-Path -Path "$file_path" -ErrorAction SilentlyContinue){ 
            $hashdata = [System.IO.File]::Open($file_path, "open", "read")
        }

        if($hashdata){ 
            $calchash = ""
            ForEach($i in $sha256.ComputeHash($hashdata) | ForEach-Object {$_.ToString("x2")}){
                $calchash += $i 
            }
            #$file_path + " " + $calchash | Out-Host

            $hashdata.dispose()
            
            if($calchash.ToUpper() -eq $compare_hash.ToUpper()){ 
                return $TRUE
            }
        }        
    }
    Catch{ 
        Write-Host "[-]Something Wrong while sha256 hash Matching." -BackgroundColor Black -ForegroundColor Red
        return $FALSE
    }
}
#**************************************************Common Functons End Line**************************************************

#**************************************************Deleted malicious schedule task by powershell!**************************************************
$deleted_schedule_task_by_namepath = $True
$malicious_task_namepaths = (
   "WindowsLogTasks",
   "System Log Security Check"
)

$deleted_schedule_task_by_action_command = $False
$deleted_schedule_task_by_execute_file_sha256 = $False

#deleted schedule tasks by task name with path
if($deleted_schedule_task_by_namepath){ 
    $task_root = "C:\Windows\System32\Tasks"

    ForEach($malicious_task in $malicious_task_namepaths){ 
        $malicious_task_path = $task_root+"\"+$malicious_task
        if(Test-Path -Path $malicious_task_path){ 
            schtasks /Delete /TN $malicious_task /F
        }
    }

}

#deleted schedule tasks by action command Fuzzy query
if($deleted_schedule_task_by_action_command){ 
    $task_files = Get-ChildItem -Path $task_root -Recurse

    ForEach($task_file in $task_files){
        ForEach($malicious_task_command in $malicious_task_commands){
            if($task_file.GetType().Name -eq "FileInfo"){ 
                $task_file_data = [XML](Get-Content $task_file.FullName)
                $task_execute_command = $task_file_data.Task.Actions.Exec.Command + " " + $task_file_data.Task.Actions.Exec.Arguments
                $command_match = $task_execute_command -like "*"+$malicious_task_command+"*"
                if($command_match){ 
                    $task_name = $task_file.Parent + "\" + $task_file.BaseName
                    if(Test-Path -Path ($task_root + "\" + $task_name)){ 
                        schtasks /Delete /TN $task_name /F
                    }
                }
            }
        }
    }
}


#deleted schedule tasks by execute file sha256 hash
if($deleted_schedule_task_by_execute_file_sha256){ 

    $task_root = "C:\Windows\System32\Tasks"
    $task_files = Get-ChildItem -Path $task_root -Recurse

    ForEach($task_file in $task_files){
        ForEach($malicious_task_file_hash in $malicious_task_execute_file_hashs){
            if($task_file.GetType().Name -eq "FileInfo"){ 
                $task_file_data = [XML](Get-Content $task_file.FullName)
                $task_execute_command = $task_file_data.Task.Actions.Exec.Command

                if($task_execute_command -like '"*"'){
                    $task_execute_command = $task_execute_command.Replace('"', "")
                }

                if($task_execute_command -like "%*%*"){ 
                    $task_execute_command = [System.Environment]::ExpandEnvironmentVariables($task_execute_command)
                }

                if($task_execute_command){ 
                    if(hash_and_compare -file_path $task_execute_command -compare_hash $malicious_task_file_hash){ 
                        $task_name = $task_file.Parent + "\" + $task_file.BaseName
                        if(Test-Path -Path ($task_root + "\" + $task_name)){ 
                            schtasks /Delete /TN $task_name /F
                        }
                        if(Test-Path -Path $task_execute_command){ 
                            Remove-Item -Path $task_execute_command -Confirm:$False
                        }
                    }
                }
            }
        }
    }
}
#**************************************************Deleted Schedule Tasks End Line**************************************************


#**************************************************Deleted malicious process by powershell!**************************************************
$kill_process_by_name = $false
$kill_process_by_file_hash = $True
$malicious_process_filehashs = (
   "F90BCF5B649EBB61D1B2A1A973C04312E3E72A71D4393CCBB12B9FA593637D62"
)

$kill_process_by_commandline = $True
$malicious_process_commandlines = (
   "powershell.exe*NoP*NonI*Hidden"
)

#kill process by process name
if($kill_process_by_name){ 
    Try{ 
        ForEach($malicious_process_name in $malicious_process_names){ 
            $process  = Get-Process -Name $malicious_process_name -ErrorAction SilentlyContinue
            if($process){ 
                if($process.count -gt 1){ 
                    ForEach($ps in $process){ 
                        $ps.Kill()
                        $namepid = $ps.Name + " " + $ps.Id
                        
                        Write-Host "[+] Kill malicious process $namepid  successfully." -ForegroundColor Green -BackgroundColor Black
                    }
                }
                else{ 
                    $process.Kill()
                    $namepid = $malicious_process_name + " " + $process.Id
                    Write-Host "[+] Kill malicious process $namepid successfully." -ForegroundColor Green -BackgroundColor Black
                }
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while kill process by name." -ForegroundColor Red -BackgroundColor Balck
    }
}

#kill process by execute file hash
if($kill_process_by_file_hash){ 
    Try{ 
        $process_all  = Get-Process
        ForEach($process in $process_all){ 
            ForEach($malicious_process_filehash in $malicious_process_filehashs){ 
                $process_path = $process.Path
                if($process_path){ 
                    if(hash_and_compare -file_path $process_path -compare_hash $malicious_process_filehash){ 
                        $namepid = $process.Name + " " + $process.Id
                        $process.Kill()
                        Write-Host "[+] Kill malicious process $namepid successfully." -ForegroundColor Green -BackgroundColor Black
                    }
                }
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while kill process." -ForegroundColor Red -BackgroundColor Black
    }
}

#kill process by process's commandline
if($kill_process_by_commandline){ 
    Try{ 
        $processes = Get-WmiObject -Class Win32_Process
        ForEach($process in $processes){ 
            $commandline = $process.CommandLine
            if($commandline){ 
                $commandline = $process.CommandLine.Tolower()

                ForEach($malicious_process_commandline in $malicious_process_commandlines){
                    $lower_malicious_commandline = $malicious_process_commandline.Tolower()
                    $match = $commandline -like "*$lower_malicious_commandline*"
                    if($match){ 
                        Write-Host "[*] Found malicious process " $process.Name  " with pid " $process.ProcessID -ForegroundColor Green -BackgroundColor black
                        Stop-Process  -Id $process.ProcessID -Force -Confirm:$False
                        Write-Host "[+] Stop malicious process " $process.Name " with pid " $process.ProcessID " successfully." -ForegroundColor Green -BackgroundColor black
                        break
                    }
                }
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while killing process by commandline."
    }
}#**************************************************Kill malicious process End Line**************************************************


#**************************************************Deleted malicious files by powershell!**************************************************
$delete_file_by_filenames = $false
$delete_file_by_file_hash = $true
$malicious_file_namehashs = @{
   "C:\Windows\Temp\cohernece.exe"="F90BCF5B649EBB61D1B2A1A973C04312E3E72A71D4393CCBB12B9FA593637D62"
}

#delete file by filenames
if($delete_file_by_filenames){ 
    Try{ 
        ForEach($malicious_file_name in $malicious_file_names){ 
            if(Test-Path -Path $malicious_file_name){ 
                Remove-Item -Path $malicious_file_name -Confirm:$false -ErrorAction SilentlyContinue
                Write-Host "[+] Delete $malicious_file_name successfully."  -ForegroundColor Green -BackgroundColor Black
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while delete file by name" -ForegroundColor Red -BackgroundColor Black
    }
    
}

#delete file by file namehash
if($delete_file_by_file_hash){ 
    Try{ 
        ForEach($filename in $malicious_file_namehashs.Keys){ 
            if(Test-Path -Path $filename){ 
                if(hash_and_compare -file_path $filename -compare_hash $malicious_file_namehashs[$filename]){ 
                    Remove-Item -Path $filename -Confirm:$false -ErrorAction SilentlyContinue
                    Write-Host "[+] Delete $filename by filehash successfully."  -ForegroundColor Green -BackgroundColor Black
                }
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while delete file by file hash" -ForegroundColor Red -BackgroundColor Black
    }
}#**************************************************Deleted malicious Files End Line**************************************************


#**************************************************Deleted malicious wmi by powershell!**************************************************
$delete_wmi_by_wmi_name = $True
$malicious_wmi_names = (
   "Windows Events Consumer"
)
$delete_wmi_by_wmi_eventconsumer_commandline = $False
#delete wmi by eventfilter name
if($delete_wmi_by_wmi_name){ 
    Try{ 
        ForEach($malicious_wmi_name in $malicious_wmi_names){
            $event_filter_binder = Get-WmiObject -Namespace root\subscription -Class __FilterToConsumerBinding | Where-Object {$_.Filter -like "*$malicious_wmi_name*"}
            $event_consumer_binder = Get-WmiObject -Namespace root\subscription -Class __FilterToConsumerBinding | Where-Object {$_.Consumer -like "*$malicious_wmi_name*"}
            $event_filter_consumer_binder = $null
            if($event_filter_binder){ 
                $event_filter_consumer_binder = $event_filter_binder
            }
            elseif($event_consumer_binder){
                $event_filter_consumer_binder = $event_consumer_binder
            }
            else{ 
                Write-Host "[*] Not Found malicious wmi $malicious_wmi_name" -ForegroundColor yellow -BackgroundColor black
                continue
            }
            Write-Host "[+] Found malicious wmi $malicious_wmi_name" -ForegroundColor Green -BackgroundColor black

            #get eventfilter_name and eventconsumer_name
            $event_filter_name = $event_filter_consumer_binder.Filter.Split('"')[1]
            $event_consumer_name = $event_filter_consumer_binder.Consumer.Split('"')[1]


            $event_filter = Get-WmiObject -Namespace root\subscription -Class __EventFilter -Filter "Name='$event_filter_name'"
            if($event_filter){ 
                Write-Host "[+] Delete $event_filter_name EventFilter successfully." -ForegroundColor Green -BackgroundColor black
                $event_filter | Remove-WmiObject
            }

            $event_consumer = Get-WmiObject -Namespace root\subscription -Class CommandLineEventConsumer -Filter "Name='$event_consumer_name'"
            if($event_consumer){ 
                Write-Host "[+] Delete $event_consumer successfully." -ForegroundColor Green -BackgroundColor black
                $event_consumer | Remove-WmiObject
            }

            Write-Host "[+] Delete $malicious_wmi_name FilterToConsumerBinding successfully." -ForegroundColor Green -BackgroundColor black
            $event_filter_consumer_binder | Remove-WmiObject
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while deleting wmi by name." -ForegroundColor Red -BackgroundColor black
    }
}

#delete wmi by wmi eventconsumer commandline
if($delete_wmi_by_wmi_eventconsumer_commandline){ 
    Try{ 
        $event_consumers = Get-WmiObject -Namespace root\subscription -Class CommandLineEventConsumer
        if($event_consumers){ 
             ForEach($malicious_wmi_eventconsumer_commandline in $malicious_wmi_eventconsumer_commandlines){ 
                ForEach($event_consumer in $event_consumers){ 
                    if($event_consumer.CommandLineTemplate){ 
                        $match = $event_consumer.CommandLineTemplate -like "*$malicious_wmi_eventconsumer_commandline*"
                        if($match){ 
                            $event_consumer_name = $event_consumer.Name
                            $event_filter = Get-WmiObject -Namespace root\subscription -Class __EventFilter -Filter "Name='$event_consumer_name'"
                            if($event_filter){ 
                                Write-Host "[+] Delete $event_consumer_name EventFilter successfully." -ForegroundColor Green -BackgroundColor black
                                $event_filter | Remove-WmiObject

                                $event_filter_consumer_binder = Get-WmiObject -Namespace root\subscription -Class __FilterToConsumerBinding | Where-Object {$_.Filter -like "*$event_consumer_name*"}
                                if($event_filter_consumer_binder){ 
                                    Write-Host "[+] Delete $event_consumer_name filter consumer binding successfully." -ForegroundColor Green -BackgroundColor black
                                    $event_filter_consumer_binder | Remove-WmiObject
                                }
                            }

                            Write-Host "[+] Delete $event_consumer successfully." -ForegroundColor Green -BackgroundColor black
                            $event_consumer | Remove-WmiObject
                        }    
                    }
                }
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while deleting wmi by event consumer commandline." -ForegroundColor red -BackgroundColor black
    }
}#**************************************************Kill malicious wmi End Line**************************************************

