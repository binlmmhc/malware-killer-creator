#**************************************************Common Functons For All**************************************************
$sha256 = New-Object System.Security.Cryptography.SHA256Managed
Function hash_and_compare($file_path, $compare_hash){ 
    Try{ 
        if(Test-Path -Path "$file_path" -ErrorAction SilentlyContinue){ 
            $hashdata = [System.IO.File]::Open($file_path, "open", "read")
        }

        if($hashdata){ 
            $calchash = ""
            ForEach($i in $sha256.ComputeHash($hashdata) | ForEach-Object {$_.ToString("x2")}){
                $calchash += $i 
            }
            #$file_path + " " + $calchash | Out-Host

            $hashdata.dispose()
            
            if($calchash.ToUpper() -eq $compare_hash.ToUpper()){ 
                return $TRUE
            }
        }        
    }
    Catch{ 
        Write-Host "[-]Something Wrong while sha256 hash Matching." -BackgroundColor Black -ForegroundColor Red
        return $FALSE
    }
}
#**************************************************Common Functons End Line**************************************************

#**************************************************Deleted malicious registry by powershell!**************************************************
Remove-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "Run" -Confirm:$False -ErrorAction SilentlyContinue
Remove-ItemProperty -Path "HKCU:\TestKey1" -Name "TestValue1" -Confirm:$False -ErrorAction SilentlyContinue
Remove-Item -Path "HKCU:\TestKey2" -Confirm:$False -ErrorAction SilentlyContinue
Remove-Item -Path "HKCU:\TestKey3" -Confirm:$False -ErrorAction SilentlyContinue
#**************************************************Deleted malicious registry End Line**************************************************


#**************************************************Deleted malicious schedule task by powershell!**************************************************
$deleted_schedule_task_by_namepath = $True
$malicious_task_namepaths = (
   "test taskname 1",
   "Microsoft\test taskname 2"
)

$deleted_schedule_task_by_action_command = $True
$malicious_task_commands = (
   "powershell*nop*bypass*-e"
)

$deleted_schedule_task_by_execute_file_sha256 = $True
$malicious_task_execute_file_hashs = (
   "807126CBAE47C03C99590D081B82D5761E0B9C57A92736FC8516CF41BC564A7D"
)


#deleted schedule tasks by task name with path
#note: \ is the root directory in schedule tasks namespace
#$malicious_task_namepaths = ( 
#    "DnsScan"
#)
if($deleted_schedule_task_by_namepath){ 
    $task_root = "C:\Windows\System32\Tasks"

    ForEach($malicious_task in $malicious_task_namepaths){ 
        $malicious_task_path = $task_root+"\"+$malicious_task
        if(Test-Path -Path $malicious_task_path){ 
            schtasks /Delete /TN $malicious_task /F
        }
    }

}

#deleted schedule tasks by action command Fuzzy query
#$malicious_task_commands = (
#    "powershell*nop*bypass*-e"
#)
if($deleted_schedule_task_by_action_command){ 
    $task_files = Get-ChildItem -Path $task_root -Recurse

    ForEach($task_file in $task_files){
        ForEach($malicious_task_command in $malicious_task_commands){
            if($task_file.GetType().Name -eq "FileInfo"){ 
                $task_file_data = [XML](Get-Content $task_file.FullName)
                $task_execute_command = $task_file_data.Task.Actions.Exec.Command + " " + $task_file_data.Task.Actions.Exec.Arguments
                $command_match = $task_execute_command -like "*"+$malicious_task_command+"*"
                if($command_match){ 
                    $task_name = $task_file.Parent + "\" + $task_file.BaseName
                    if(Test-Path -Path ($task_root + "\" + $task_name)){ 
                        schtasks /Delete /TN $task_name /F
                    }
                }
            }
        }
    }
}


#deleted schedule tasks by execute file sha256 hash
#$malicious_task_execute_file_hashs = (
#    "807126CBAE47C03C99590D081B82D5761E0B9C57A92736FC8516CF41BC564A7D"
#)
if($deleted_schedule_task_by_execute_file_sha256){ 

    $task_root = "C:\Windows\System32\Tasks"
    $task_files = Get-ChildItem -Path $task_root -Recurse

    ForEach($task_file in $task_files){
        ForEach($malicious_task_file_hash in $malicious_task_execute_file_hashs){
            if($task_file.GetType().Name -eq "FileInfo"){ 
                $task_file_data = [XML](Get-Content $task_file.FullName)
                $task_execute_command = $task_file_data.Task.Actions.Exec.Command

                if($task_execute_command -like '"*"'){
                    $task_execute_command = $task_execute_command.Replace('"', "")
                }

                if($task_execute_command -like "%*%*"){ 
                    $task_execute_command = [System.Environment]::ExpandEnvironmentVariables($task_execute_command)
                }

                if($task_execute_command){ 
                    if(hash_and_compare -file_path $task_execute_command -compare_hash $malicious_task_file_hash){ 
                        $task_name = $task_file.Parent + "\" + $task_file.BaseName
                        if(Test-Path -Path ($task_root + "\" + $task_name)){ 
                            schtasks /Delete /TN $task_name /F
                        }
                        if(Test-Path -Path $task_execute_command){ 
                            Remove-Item -Path $task_execute_command -Confirm:$False
                        }
                    }
                }
            }
        }
    }
}
#**************************************************Deleted Schedule Tasks End Line**************************************************


#**************************************************Deleted malicious services by powershell!**************************************************
$delete_service_by_service_name = $true
$malicious_service_names = (
   "fake_service_name1",
   "fake_service_name2"
)

$delete_service_by_execute_file_hash = $true
$malicious_service_file_hashs = (
   "3C2FE308C0A563E06263BBACF793BBE9B2259D795FCC36B953793A7E499E7F71"
)


#delete service by service name, and service name is not displayname
#$delete_service_by_service_name = $true
#$malicious_service_names = ( 
#    "ErcKTIUi"
#)
if($delete_service_by_service_name){ 
    Try{ 
        ForEach($malicious_service_name in $malicious_service_names){ 
            $find_service = Get-Service -Name $malicious_service_name -ErrorAction SilentlyContinue
            if($find_service){ 
                if($find_service.Status -eq "Running"){ 
                   if($find_service.CanStop){ 
                       $find_service.Stop()
                   }
                }
                $find_service.Dispose()
                sc.exe delete $malicious_service_names | Out-Null
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while delete service by service name." -BackgroundColor Black -ForegroundColor Red
    }
}

#delete service by service execute file sha256 hash
#$delete_service_by_execute_file_hash = $true
#$malicious_service_file_hashs = ( 
#    "3C2FE308C0A563E06263BBACF793BBE9B2259D795FCC36B953793A7E499E7F71"
#)
if($delete_service_by_execute_file_hash){ 
    Try{ 
        $services = Get-WmiObject -Class Win32_Service
        ForEach($service in $services ){ 
            $service_name = $service.Name        
            $service_execute_path = $service.PathName

            #$service_name + " " + $service_execute_path | Out-Host
            if($service_execute_path -like '"*"'){
                $service_execute_path = $service_execute_path.Replace('"', "")
            }

            if($service_execute_path -like "%*%*"){ 
                $service_execute_path = [System.Environment]::ExpandEnvironmentVariables($service_execute_path)
            }

            if($service_execute_path){ 
                ForEach($malicious_service_file_hash in $malicious_service_file_hashs){ 
                    if(hash_and_compare -file_path $service_execute_path -compare_hash $malicious_service_file_hash){ 
                        if($service.State -eq "Running"){ 
                            $service.StopService() | Out-Null
                        }
                        $service.delete() | Out-Null

                        if(Test-Path -Path $service_execute_path){ 
                            Remove-Item -Path $service_execute_path -Confirm:$False -ErrorAction SilentlyContinue
                        }
                    }
                }
                
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while delete service by service execute file hash." -BackgroundColor Black -ForegroundColor Red
    }
}
#**************************************************Deleted malicious service End Line**************************************************


#**************************************************Deleted malicious process by powershell!**************************************************
$kill_process_by_name = $true
$malicious_process_names = (
   "NsCpuCNMiner32",
   "notepad"
)

$kill_process_by_file_hash
$malicious_process_filehashs = (
   "807126CBAE47C03C99590D081B82D5761E0B9C57A92736FC8516CF41BC564A7D"
)

#kill process by process name
#$kill_process_by_name = $true
#$malicious_process_names = ( 
#    "notepad"
#)

if($kill_process_by_name){ 
    Try{ 
        ForEach($malicious_process_name in $malicious_process_names){ 
            $process  = Get-Process -Name $malicious_process_name -ErrorAction SilentlyContinue
            if($process){ 
                if($process.count -gt 1){ 
                    ForEach($ps in $process){ 
                        $ps.Kill()
                        $namepid = $ps.Name + " " + $ps.Id
                        
                        Write-Host "[+] Kill malicious process $namepid  successfully." -ForegroundColor Green -BackgroundColor Black
                    }
                }
                else{ 
                    $process.Kill()
                    $namepid = $malicious_process_name + " " + $process.Id
                    Write-Host "[+] Kill malicious process $namepid successfully." -ForegroundColor Green -BackgroundColor Black
                }
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while kill process by name." -ForegroundColor Red -BackgroundColor Balck
    }
}

#kill process by execute file hash
#$kill_process_by_file_hash = $true
#$malicious_process_filehashs = ( 
#    "899346F9F283A4FD5AA03015A3F58CDE5B9C0B6A5C4D64C2CC74E9B22C1348D7"
#)

if($kill_process_by_file_hash){ 
    Try{ 
        $process_all  = Get-Process
        ForEach($process in $process_all){ 
            ForEach($malicious_process_filehash in $malicious_process_filehashs){ 
                $process_path = $process.Path
                if($process_path){ 
                    if(hash_and_compare -file_path $process_path -compare_hash $malicious_process_filehash){ 
                        $namepid = $process.Name + " " + $process.Id
                        $process.Kill()
                        Write-Host "[+] Kill malicious process $namepid successfully." -ForegroundColor Green -BackgroundColor Black
                    }
                }
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while kill process." -ForegroundColor Red -BackgroundColor Black
    }
}#**************************************************Kill malicious process End Line**************************************************


#**************************************************Deleted malicious files by powershell!**************************************************
$delete_file_by_filenames = $true
$malicious_file_names = (
   "C:\Users\binlmmhc\AppData\Local\Temp\pools.txt",
   "C:\Photo.scr"
)

$delete_file_by_file_hash = $true
$malicious_file_namehashs = @{
   "C:\Users\binlmmhc\AppData\Local\Temp\NsCpuCNMiner32.exe"="A0EBA3FDA0D7B22A5D694105EC700DF7C7012DDC4AE611C3071EF858E2C69F08";
   "C:\Users\binlmmhc\Music\test.txt"="E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855"
}

#delete file by filenames
#$delete_file_by_filenames = $true
#$malicious_file_names = (
#    "C:\Users\binlmmhc\AppData\Local\Temp\pools.txt"
#)
if($delete_file_by_filenames){ 
    Try{ 
        ForEach($malicious_file_name in $malicious_file_names){ 
            if(Test-Path -Path $malicious_file_name){ 
                Remove-Item -Path $malicious_file_name -Confirm:$false -ErrorAction SilentlyContinue
                Write-Host "[+] Delete $malicious_file_name successfully."  -ForegroundColor Green -BackgroundColor Black
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while delete file by name" -ForegroundColor Red -BackgroundColor Black
    }
    
}

#delete file by file namehash
#$delete_file_by_file_hash = $true
#$malicious_file_namehashs = @{ 
#    "C:\Users\binlmmhc\AppData\Local\Temp\NsCpuCNMiner32.exe"="A0EBA3FDA0D7B22A5D694105EC700DF7C7012DDC4AE611C3071EF858E2C69F08";
#    "C:\Users\binlmmhc\Music\test.txt"="E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855"
#}
if($delete_file_by_file_hash){ 
    Try{ 
        ForEach($filename in $malicious_file_namehashs.Keys){ 
            if(Test-Path -Path $filename){ 
                if(hash_and_compare -file_path $filename -compare_hash $malicious_file_namehashs[$filename]){ 
                    Remove-Item -Path $filename -Confirm:$false -ErrorAction SilentlyContinue
                    Write-Host "[+] Delete $filename by filehash successfully."  -ForegroundColor Green -BackgroundColor Black
                }
            }
        }
    }
    Catch{ 
        Write-Host "[-] Some thing wrong while delete file by file hash" -ForegroundColor Red -BackgroundColor Black
    }
}#**************************************************Deleted malicious Files End Line**************************************************

