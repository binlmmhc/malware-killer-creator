import os
import sys

def create_windows_bat(config_datas):
    global testbool
    if config_datas.killername:
        if testbool:
            killer_handle = open("../output/"+config_datas.killername+".bat", "w")
        else:
            killer_handle = open("./output/"+config_datas.killername+".bat", "w")
    else:
        return "create killer's bat file failed."
    
    for item_type in config_datas.all_items:
        deleted_items = config_datas.all_items[item_type]
        if "registry" in item_type:
            bat_delete_registry(killer_handle, deleted_items)
        if "schedule_task" in item_type:
            bat_delete_tasks_by_name(killer_handle, deleted_items)
        if "services" in item_type:
            bat_delete_srv_by_name(killer_handle, deleted_items)
        if "process_names" in item_type:
            bat_kill_process_by_name(killer_handle, deleted_items)
        if "files" in item_type:
            bat_delete_file_by_name(killer_handle, deleted_items)
        killer_handle.write("\n")

    killer_handle.close()

    return


def bat_delete_file_by_name(killer_handle, filenames):
    if not killer_handle:
        return "delete file by name failed."
    
    for file_type,file_name in filenames.items():
        if "name" in file_type:
            killer_handle.write(r'del /F "' + file_name + '"\n')
    
    return 0

def bat_delete_registry(killer_handle, key_values):
    if not killer_handle:
        return "delete reg item failed."
    
    #reg is a list contain item, value
    for regkeyitem,regvalue in key_values.items():
        if regvalue != 0:
            killer_handle.write(r'reg delete "' + regkeyitem + '" /v "' + regvalue + '" /f' + '\n')
        else:
            killer_handle.write(r'reg delete "' + regkeyitem + '" /f' + '\n')
    return 0

def bat_delete_srv_by_name(killer_handle, srvnames):
    if not killer_handle:
        return "delete services by name failed."
    
    for service_type, service_name in srvnames.items():
        if "name" in service_type:
            killer_handle.write(r'sc stop "' + service_name + '"\n')
            killer_handle.write(r'sc delete "' + service_name + '"\n')
    
    return 0

def bat_delete_tasks_by_name(killer_handle, tasknames):
    if not killer_handle:
        return "delete tasks by name failed."
    
    for tasktype, taskname in tasknames.items():
        if "taskname" in tasktype:
            killer_handle.write(r'schtasks /delete /TN "' + taskname + '" /F' + '\n')
    
    return 0

def bat_kill_process_by_name(killer_handle, processes):
    if not killer_handle:
        return "kill process by name failed."
    
    for process_type, process_name in processes.items():
        if "name" in process_type:
            killer_handle.write(r'taskkill /IM "' + process_name + '" /F\n')
    
    return 0


testbool = False

def test():
    #it will auto add .bat
    config_datas = config("testkiller", "2019-03-19")
    create_windows_bat(config_datas)

if __name__ == '__main__':
    from config_data import *

    testbool = True

    test()