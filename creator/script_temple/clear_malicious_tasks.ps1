#deleted schedule tasks by task name with path
$malicious_task_namepaths = ( 
    "DnsScan"
)
if($deleted_schedule_task_by_namepath){ 
    $task_root = "C:\Windows\System32\Tasks"

    ForEach($malicious_task in $malicious_task_namepaths){ 
        $malicious_task_path = $task_root+"\"+$malicious_task
        if(Test-Path -Path $malicious_task_path){ 
            schtasks /Delete /TN $malicious_task /F
            Write-Host "[+] Delete malicious task $malicious_task_path succesfully." -ForegroundColor Green -BackgroundColor Black
        }
    }

}

#deleted schedule tasks by action command Fuzzy query
$malicious_task_commands = (
    "powershell*nop*bypass*-e"
)
if($deleted_schedule_task_by_action_command){ 
    $task_files = Get-ChildItem -Path $task_root -Recurse

    ForEach($task_file in $task_files){
        ForEach($malicious_task_command in $malicious_task_commands){
            if($task_file.GetType().Name -eq "FileInfo"){ 
                $task_file_data = [XML](Get-Content $task_file.FullName)
                $task_execute_command = $task_file_data.Task.Actions.Exec.Command + " " + $task_file_data.Task.Actions.Exec.Arguments
                $command_match = $task_execute_command -like "*"+$malicious_task_command+"*"
                if($command_match){ 
                    $task_name = $task_file.Parent + "\" + $task_file.BaseName
                    if(Test-Path -Path ($task_root + "\" + $task_name)){ 
                        schtasks /Delete /TN $task_name /F
                        Write-Host "[+] Delete malicious task $task_name succesfully." -ForegroundColor Green -BackgroundColor Black
                    }
                }
            }
        }
    }
}


#deleted schedule tasks by execute file sha256 hash
$malicious_task_execute_file_hashs = (
    "807126CBAE47C03C99590D081B82D5761E0B9C57A92736FC8516CF41BC564A7D"
)
if($deleted_schedule_task_by_execute_file_sha256){ 

    $task_root = "C:\Windows\System32\Tasks"
    $task_files = Get-ChildItem -Path $task_root -Recurse

    ForEach($task_file in $task_files){
        ForEach($malicious_task_file_hash in $malicious_task_execute_file_hashs){
            if($task_file.GetType().Name -eq "FileInfo"){ 
                $task_file_data = [XML](Get-Content $task_file.FullName)
                $task_execute_command = $task_file_data.Task.Actions.Exec.Command

                if($task_execute_command -like '"*"'){
                    $task_execute_command = $task_execute_command.Replace('"', "")
                }

                if($task_execute_command -like "%*%*"){ 
                    $task_execute_command = [System.Environment]::ExpandEnvironmentVariables($task_execute_command)
                }

                if($task_execute_command){ 
                    if(hash_and_compare -file_path $task_execute_command -compare_hash $malicious_task_file_hash){ 
                        $task_name = $task_file.Parent + "\" + $task_file.BaseName
                        if(Test-Path -Path ($task_root + "\" + $task_name)){ 
                            schtasks /Delete /TN $task_name /F
                            Write-Host "[+] Delete malicious task $malicious_task_path succesfully." -ForegroundColor Green -BackgroundColor Black
                        }
                        if(Test-Path -Path $task_execute_command){ 
                            Remove-Item -Path $task_execute_command -Confirm:$False
                            Write-Host "[+] Delete malicious task executable file $task_execute_command successfully." -ForegroundColor Green -BackgroundColor Black
                        }
                    }
                }
            }
        }
    }
}